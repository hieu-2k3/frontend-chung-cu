<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh Sách Cư Dân - Quản Lý Chung Cư</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .user-dashboard {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .contract-hover-effect:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.1) !important;
        }

        .section-title {
            color: white;
            font-size: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--accent-blue);
            padding-left: 1rem;
        }

        .residents-directory {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .room-entry {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: var(--transition);
        }

        .room-entry:hover {
            transform: translateY(-5px);
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .room-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-blue);
        }

        .member-count {
            font-size: 0.85rem;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2rem 0.6rem;
            border-radius: 1rem;
        }

        .member-list {
            list-style: none;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .member-item:last-child {
            margin-bottom: 0;
        }

        .member-avatar {
            width: 32px;
            height: 32px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 500;
            display: block;
        }

        .member-role {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            color: var(--text-secondary);
        }

        /* Receipt Styles */
        .receipt {
            padding: 1rem;
            color: var(--text-primary);
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 2px dashed var(--card-border);
            padding-bottom: 1rem;
        }

        .receipt-header h3 {
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }

        .receipt-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .receipt-total {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 2px solid var(--card-border);
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--accent-green);
        }

        .payment-qr {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--card-border);
            text-align: center;
        }

        .payment-qr p {
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .payment-qr small {
            color: var(--accent-blue);
            display: block;
        }

        .paid-stamp {
            margin: 2rem auto 0;
            width: fit-content;
            padding: 0.5rem 2rem;
            border: 4px solid #10b981;
            color: #10b981;
            font-size: 1.5rem;
            font-weight: 900;
            transform: rotate(-10deg);
            border-radius: 0.5rem;
            opacity: 0.8;
            letter-spacing: 2px;
        }

        .btn-check {
            padding: 0.5rem 1rem;
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
            border: 1px solid var(--accent-blue);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-check:hover {
            background: var(--accent-blue);
            color: white;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-badge.pending {
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status-badge.paid {
            background: rgba(16, 185, 129, 0.1);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
    </style>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body>
    <!-- Server Wakeup Loading Screen -->
    <div id="wakeup-loading" class="wakeup-overlay">
        <div class="wakeup-content">
            <div class="wakeup-spinner-wrapper">
                <div class="wakeup-spinner"></div>
                <i class="fa-solid fa-building-circle-check wakeup-icon"></i>
            </div>
            <h2 class="wakeup-title">Đang Khởi Động Máy Chủ</h2>
            <p class="wakeup-text">
                Hệ thống đang được đánh thức. Vì sử dụng máy chủ miễn phí, quá trình này có thể mất từ 30-60 giây. Vui
                lòng giữ nguyên màn hình.
            </p>
            <div class="wakeup-progress">
                <div class="wakeup-progress-bar"></div>
            </div>
        </div>
    </div>

    <!-- Market Post Modal -->
    <div id="market-modal" class="modal hidden">
        <div class="modal-content glass-panel" style="max-width: 450px;">
            <span class="close-modal" id="close-market-modal">&times;</span>
            <div class="modal-header">
                <h2><i class="fa-solid fa-store"></i> Đăng Tin Rao Vặt</h2>
            </div>
            <div class="modal-body modal-body-scroll">
                <form id="market-form" class="premium-form">
                    <div class="form-group">
                        <label>Tiêu đề món đồ</label>
                        <input type="text" id="mkt-title" placeholder="Ví dụ: Tủ lạnh mini cũ..." required>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label>Giá bán (đ)</label>
                            <input type="number" id="mkt-price" placeholder="500000" required>
                        </div>
                        <div class="form-group">
                            <label>SĐT Liên hệ</label>
                            <input type="text" id="mkt-phone" placeholder="09xxxx" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Mô tả chi tiết</label>
                        <textarea id="mkt-desc" rows="3"
                            style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 8px; padding: 0.5rem;"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Ảnh thực tế (Bắt buộc)</label>
                        <div
                            style="background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 0.5rem; border: 1px dashed rgba(255,255,255,0.2);">
                            <input type="file" id="mkt-file" accept="image/*" required
                                style="border: none; padding: 0.5rem;">
                            <div id="mkt-preview" style="margin-top: 0.5rem; display: none; text-align: center;"></div>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary w-100">
                        <i class="fa-solid fa-paper-plane"></i> Đăng Ngay
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <div class="app-container">
        <header class="main-header">
            <div class="header-left" onclick="location.reload()" style="cursor: pointer;">
                <h1><i class="fa-solid fa-building-user"></i> Chung Cư Hạnh Phúc</h1>
                <p class="subtitle">Danh sách cư dân</p>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <i class="fa-solid fa-user-circle"></i>
                    <span id="user-name">Cư dân</span>
                </div>
                <button class="btn-logout" onclick="handleLogout()">
                    <i class="fa-solid fa-right-from-bracket"></i> Đăng xuất
                </button>
            </div>
        </header>

        <div class="user-dashboard">
            <!-- Announcements Section -->
            <div id="user-announcement-section" style="margin-bottom: 2rem; display: none;">
                <h2 class="section-title"><i class="fa-solid fa-bullhorn"></i> Bảng Tin Chung</h2>
                <div id="user-announcement-list"></div>
            </div>
            <!-- Market Section -->
            <div id="user-market-section" class="glass-panel" style="margin-bottom: 2rem;">
                <div class="section-header"
                    style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <h2 class="section-title" style="margin-bottom: 0; border: none; padding: 0;"><i
                            class="fa-solid fa-store"></i> Chợ Cư Dân</h2>
                    <button id="btn-open-market-modal" class="btn-primary" onclick="openMarketModal()"
                        style="width: auto;">
                        <i class="fa-solid fa-camera"></i> Đăng tin
                    </button>
                </div>
                <div id="user-market-list" style="display: flex; gap: 1.5rem; overflow-x: auto; padding-bottom: 1rem;">
                    <div style="text-align: center; color: #aaa; width: 100%; padding: 2rem;">Đang tải tin...</div>
                </div>
            </div>

            <h2 class="section-title" id="room-directory-title" style="margin-top: 3rem;">Thông Tin Phòng & Cư Dân</h2>
            <div id="directory-grid" class="residents-directory">
                <!-- Room entries will be loaded here -->
                <div class="empty-state">
                    <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
                    <p style="margin-top: 1rem">Đang tải dữ liệu...</p>
                </div>
            </div>

            <!-- Contracts Section -->
            <h2 class="section-title" style="margin-top: 3rem;">Hợp Đồng Thuê Nhà</h2>
            <div id="user-contract-section" style="margin-bottom: 2rem;">
                <div class="glass-panel" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                    <i class="fa-solid fa-spinner fa-spin"></i> Đang tải thông tin hợp đồng...
                </div>
            </div>

            <!-- Invoices Section -->
            <h2 class="section-title" style="margin-top: 3rem;">Hóa Đơn Của Bạn</h2>
            <div class="glass-panel" style="margin-top: 1rem; padding: 1.5rem;">
                <div class="table-container">
                    <table class="data-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr
                                style="text-align: left; color: var(--text-secondary); border-bottom: 2px solid var(--card-border);">
                                <th style="padding: 1rem;">Tháng/Năm</th>
                                <th style="padding: 1rem;">Tổng Tiền</th>
                                <th style="padding: 1rem;">Trạng Thái</th>
                                <th style="padding: 1rem;">Thao Tác</th>
                            </tr>
                        </thead>
                        <tbody id="user-invoice-list">
                            <!-- Invoices will be here -->
                            <tr>
                                <td colspan="4" style="text-align:center; padding: 2rem;">Đang tải hóa đơn...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Maintenance Section -->
            <h2 class="section-title" style="margin-top: 3rem;">Bảo Trì & Phản Hồi</h2>
            <div class="glass-panel" style="margin-top: 1rem; padding: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Gửi yêu cầu sửa chữa hoặc góp ý cho
                        tòa
                        nhà.</p>
                    <button id="btn-user-open-maintenance" class="btn-primary" onclick="openMaintenanceModal()"
                        style="width: auto; padding: 0.5rem 1.5rem;">
                        <i class="fa-solid fa-plus"></i> Tạo Yêu Cầu
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr
                                style="text-align: left; color: var(--text-secondary); border-bottom: 2px solid var(--card-border);">
                                <th style="padding: 1rem;">Ngày gửi</th>
                                <th style="padding: 1rem;">Tiêu đề</th>
                                <th style="padding: 1rem;">Loại</th>
                                <th style="padding: 1rem;">Trạng Thái</th>
                                <th style="padding: 1rem;">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="user-maintenance-list">
                            <!-- Maintenance requests will be here -->
                            <tr>
                                <td colspan="5" style="text-align:center; padding: 2rem;">Đang tải dữ liệu...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Contract Detail Modal -->
    <div id="user-contract-modal" class="modal hidden">
        <div class="modal-content glass-panel"
            style="max-width: 550px; width: 95%; max-height: 80vh; display: flex; flex-direction: column;">
            <span class="close-modal" id="close-user-contract" style="z-index: 10;">&times;</span>
            <div class="modal-header" style="flex-shrink: 0; margin-bottom: 1rem;">
                <h2><i class="fa-solid fa-file-signature"></i> Chi Tiết Hợp Đồng</h2>
            </div>

            <div class="modal-body" id="user-contract-content"
                style="overflow-y: auto; flex: 1; padding-right: 0.5rem; scrollbar-width: thin;">
                <!-- Content injected via JS -->
            </div>

            <div
                style="margin-top: 1rem; text-align: center; flex-shrink: 0; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <button class="btn-primary" onclick="window.print()"
                    style="padding: 0.5rem 1.5rem; width: auto; font-size: 0.9rem;">
                    <i class="fa-solid fa-print"></i> In Hợp Đồng
                </button>
            </div>
        </div>
    </div>

    <!-- Invoice Detail Modal -->
    <div id="invoice-detail-modal" class="modal hidden">
        <div class="modal-content glass-panel" style="max-width: 600px; width: 95%;">
            <span class="close-modal" id="close-invoice-detail">&times;</span>
            <div class="form-scroll-area" style="max-height: 80vh; margin-top: 1rem;">
                <div id="invoice-receipt-content">
                    <!-- Receipt detail will be loaded here -->
                </div>
            </div>
            <div style="margin-top: 1.5rem; text-align: center;">
                <button class="btn-primary" onclick="window.print()" style="padding: 0.6rem 2rem;">
                    <i class="fa-solid fa-print"></i> In Hóa Đơn
                </button>
            </div>
        </div>
    </div>

    <!-- Maintenance Request Modal -->
    <div id="maintenance-modal" class="modal hidden">
        <div class="modal-content glass-panel" style="max-width: 450px; width: 95%;">
            <span class="close-modal" id="close-maintenance">&times;</span>
            <div class="modal-header">
                <h2 style="color: var(--accent-blue); margin-bottom: 1rem;"><i class="fa-solid fa-paper-plane"></i>
                    Gửi Yêu Cầu Mới</h2>
            </div>
            <div class="modal-body modal-body-scroll">
                <form id="maintenance-form">
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Loại yêu
                            cầu</label>
                        <select id="maint-type"
                            style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; background: rgba(0,0,0,0.2); color: white; border: 1px solid rgba(255,255,255,0.1);">
                            <option value="maintenance">Sửa chữa / Bảo trì</option>
                            <option value="feedback">Góp ý / Khiếu nại</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Mức độ
                            ưu
                            tiên</label>
                        <select id="maint-priority"
                            style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; background: rgba(0,0,0,0.2); color: white; border: 1px solid rgba(255,255,255,0.1);">
                            <option value="low">Thấp</option>
                            <option value="medium" selected>Trung bình</option>
                            <option value="high">Khẩn cấp (Cần xử lý ngay)</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Tiêu
                            đề</label>
                        <input type="text" id="maint-title" placeholder="Ví dụ: Hỏng bóng đèn, Rò rỉ nước..." required
                            style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; background: rgba(0,0,0,0.2); color: white; border: 1px solid rgba(255,255,255,0.1);">
                    </div>
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Mô tả
                            chi
                            tiết</label>
                        <textarea id="maint-description" rows="4" placeholder="Mô tả cụ thể vấn đề của bạn..." required
                            style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; background: rgba(0,0,0,0.2); color: white; border: 1px solid rgba(255,255,255,0.1); font-family: inherit; resize: vertical;"></textarea>
                    </div>
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">
                            <i class="fa-solid fa-image"></i> Ảnh minh họa (Tùy chọn)
                        </label>
                        <div
                            style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 0.5rem; border: 1px dashed rgba(255,255,255,0.2);">
                            <input type="file" id="maint-media" accept="image/*"
                                style="width: 100%; padding: 0.5rem; background: transparent; color: white; border: none;">
                            <div id="maint-media-preview"
                                style="margin-top: 0.75rem; display: none; text-align: center;"></div>
                            <small style="display: block; margin-top: 0.5rem; color: #94a3b8; font-size: 0.75rem;">
                                <i class="fa-solid fa-info-circle"></i> Chụp ảnh sự cố để Admin xử lý nhanh hơn (Tối đa
                                2MB)
                            </small>
                        </div>
                    </div>
                    <div style="margin-top: 2rem;">
                        <button type="submit" class="btn-primary" style="width: 100%; padding: 1rem;">
                            <i class="fa-solid fa-paper-plane"></i> Gửi Yêu Cầu
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Logout Modal -->
    <div id="logout-confirm-modal" class="modal hidden">
        <div class="modal-content glass-panel" style="max-width: 400px; text-align: center;">
            <div class="logout-confirm-icon">
                <i class="fa-solid fa-right-from-bracket"></i>
            </div>
            <h2 style="margin-bottom: 1rem;">Đăng Xuất</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">Bạn có chắc chắn muốn đăng xuất?</p>
            <div class="delete-confirm-buttons">
                <button class="btn-cancel" id="btn-cancel-logout">Huỷ bỏ</button>
                <button class="btn-confirm-delete" id="btn-confirm-logout" style="background: var(--accent-blue);">Đăng
                    Xuất</button>
            </div>
        </div>
    </div>

    <!-- Maintenance Detail Modal -->
    <div id="maint-detail-modal" class="modal hidden">
        <div class="modal-content glass-panel">
            <span class="close-modal" id="close-maint-detail">&times;</span>
            <div class="modal-header">
                <h2><i class="fa-solid fa-circle-info"></i> Chi tiết Yêu cầu</h2>
            </div>
            <div class="modal-body" id="maint-detail-body">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- Announcement Detail Modal -->
    <div id="ann-detail-modal" class="modal hidden">
        <div class="modal-content glass-panel">
            <span class="close-modal" id="close-ann-detail">&times;</span>
            <div class="modal-header">
                <h2 id="ann-detail-title-head">Chi tiết Thông báo</h2>
            </div>
            <div class="modal-body" id="ann-detail-body">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- Market Detail Modal -->
    <div id="mkt-detail-modal" class="modal hidden">
        <div class="modal-content glass-panel">
            <span class="close-modal" id="close-mkt-detail">&times;</span>
            <div class="modal-header">
                <h2>Chi tiết Rau củ / Đồ dùng</h2>
            </div>
            <div class="modal-body" id="mkt-detail-body">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- Chat Widget -->
    <!-- Chat Widget -->
    <div id="chat-widget" class="chat-widget hidden">
        <div class="chat-header">
            <div id="chat-header-content" style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
                <h3 id="chat-title"><i class="fa-regular fa-comments"></i> Cộng Đồng Cư Dân</h3>
            </div>
            <button id="chat-back-btn" class="hidden" onclick="returnToCommunity()"
                style="background:none; border:none; color:white; cursor:pointer; margin-right: 0.5rem;">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <span class="close-chat" onclick="toggleChat()">&times;</span>
        </div>
        <div class="chat-messages" id="chat-messages">
            <!-- Messages -->
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Nhập tin nhắn...">
            <button onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>
    <button id="chat-fab" class="chat-fab" onclick="toggleChat()">
        <i class="fa-solid fa-comments"></i>
        <div class="notification-dot"></div>
    </button>

    <script>
        // --- Shared Auth Logic ---
        const API_URL = 'https://apartment-api-3jnu.onrender.com/api';

        // Wakeup logic for Render
        (function checkServer() {
            const loadingScreen = document.getElementById('wakeup-loading');
            if (!loadingScreen) return;

            const baseUrl = API_URL.replace('/api', '').replace(/\/$/, '');

            const tryFetch = async () => {
                try {
                    // Cố gắng fetch endpoint ping hoặc root
                    await fetch(baseUrl, { mode: 'no-cors' });
                    loadingScreen.classList.add('hidden');
                    console.log('Server is awake!');
                } catch (e) {
                    console.log('Server is sleeping, retrying...');
                    setTimeout(tryFetch, 2000);
                }
            };
            tryFetch();
        })();



        // --- CHAT LOGIC ---
        let socket;
        let currentChatPartnerId = null; // null = Community Chat

        function initChat() {
            const token = localStorage.getItem('authToken');
            const userStr = localStorage.getItem('currentUser');
            if (!token || !userStr) return;
            const user = JSON.parse(userStr);

            // Connect to socket
            socket = io(API_URL.replace('/api', ''), {
                auth: { token }
            });

            socket.on('connect', () => {
                console.log('Connected to chat server');
            });

            // Handle Community & Private Messages
            socket.on('message', (msg) => {
                // Community Message
                if (!currentChatPartnerId) {
                    appendMessage(msg, user.id);
                    ifChatClosedNotify();
                }
            });

            socket.on('private_message', (msg) => {
                // Private Message
                // If I'm chatting with this person OR I sent it (echo)
                if (currentChatPartnerId && (msg.senderId === currentChatPartnerId || msg.receiverId === currentChatPartnerId)) {
                    appendMessage(msg, user.id);
                    ifChatClosedNotify();
                } else {
                    // Notification for private message from others?
                    // For now just show dot if widget closed
                    ifChatClosedNotify();
                }
            });

            // Load History (Community Default)
            loadMessages();
        }

        function ifChatClosedNotify() {
            if (document.getElementById('chat-widget').classList.contains('hidden')) {
                document.querySelector('.notification-dot').style.display = 'block';
            } else {
                scrollToBottom();
            }
        }

        function loadMessages() {
            const token = localStorage.getItem('authToken');
            const user = JSON.parse(localStorage.getItem('currentUser'));
            let url = `${API_URL}/messages`;

            if (currentChatPartnerId) {
                url += `?partnerId=${currentChatPartnerId}`;
            }

            fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const container = document.getElementById('chat-messages');
                        container.innerHTML = '';
                        data.data.forEach(msg => appendMessage(msg, user.id));
                        scrollToBottom();
                    }
                });
        }

        function toggleChat() {
            const widget = document.getElementById('chat-widget');
            widget.classList.toggle('hidden');
            if (!widget.classList.contains('hidden')) {
                document.querySelector('.notification-dot').style.display = 'none';
                scrollToBottom();
            }
        }

        window.openPrivateChat = function (partnerId, partnerName) {
            currentChatPartnerId = partnerId;

            // Validate self-chat
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (user.id === partnerId) {
                alert("Bạn không thể chat với chính mình!");
                currentChatPartnerId = null;
                return;
            }

            // Update UI Header
            document.getElementById('chat-title').innerHTML = `<i class="fa-solid fa-user"></i> ${partnerName}`;
            document.getElementById('chat-back-btn').classList.remove('hidden');

            // Open Widget & Load
            const widget = document.getElementById('chat-widget');
            widget.classList.remove('hidden');
            document.querySelector('.notification-dot').style.display = 'none';
            loadMessages();
        };

        function returnToCommunity() {
            currentChatPartnerId = null;
            document.getElementById('chat-title').innerHTML = `<i class="fa-regular fa-comments"></i> Cộng Đồng Cư Dân`;
            document.getElementById('chat-back-btn').classList.add('hidden');
            loadMessages();
        }

        function appendMessage(msg, currentUserId) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            const isSelf = msg.senderId === currentUserId;
            div.className = `message ${isSelf ? 'self' : 'other'}`;
            // If private, maybe show lighter color or icon? Keeping simple for now.
            div.innerHTML = `
                <span class="message-sender">${isSelf ? '' : msg.senderName}</span>
                ${msg.content}
            `;
            container.appendChild(div);
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-messages');
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            if (!content) return;

            const user = JSON.parse(localStorage.getItem('currentUser'));

            // Payload depends on mode
            const payload = {
                senderId: user.id,
                senderName: user.name,
                content: content
            };

            if (currentChatPartnerId) {
                payload.receiverId = currentChatPartnerId;
            }

            socket.emit('chatMessage', payload);
            input.value = '';
        }

        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        window.userHasRoom = false; // Global flag


        // Check Auth and Session
        async function checkAuth() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('currentUser');

            if (!token || !user) {
                window.location.href = 'login.html';
                return;
            }

            try {
                // Verify user still exists in DB
                const response = await fetch(`${API_URL}/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (!data.success) {
                    // User was deleted or token expired
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('currentUser');
                    window.location.href = 'login.html';
                    return;
                }

                const userData = data.user;
                document.getElementById('user-name').textContent = userData.name || 'Cư dân';

                // CRITICAL: Wait for room assignment status before loading other restricted data
                await loadDirectory();

                loadUserAnnouncements();
                loadMarketItems();
                loadInvoices();
                loadMaintenance();
                loadUserContract();

            } catch (error) {
                console.error("Auth check failed:", error);
                // If it's a network error, maybe don't redirect yet
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            checkAuth();
            initChat();
        });

        // Handle Logout
        function handleLogout() {
            document.getElementById('logout-confirm-modal').classList.remove('hidden');
        }

        // Setup Logout Modal
        const logoutModal = document.getElementById('logout-confirm-modal');
        document.getElementById('btn-cancel-logout').onclick = () => {
            logoutModal.classList.add('hidden');
        };
        document.getElementById('btn-confirm-logout').onclick = () => {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        };

        // --- Data Loading Logic ---
        async function loadDirectory() {
            const token = localStorage.getItem('authToken');
            const userStr = localStorage.getItem('currentUser');

            if (!token || !userStr) {
                window.location.href = 'login.html';
                return;
            }

            const currentUser = JSON.parse(userStr);
            const container = document.getElementById('directory-grid');

            if (!currentUser.phone) {
                container.innerHTML = '<div class="empty-state"><p>Không tìm thấy SĐT người dùng. Vui lòng đăng nhập lại.</p></div>';
                return;
            }

            // Clean phone for robust matching (remove spaces, dots, dashes)
            const userPhone = currentUser.phone.toString().replace(/[\s\.\-\(\)]/g, '');

            try {
                console.log("Fetching directory from:", `${API_URL}/apartments`);
                const response = await fetch(`${API_URL}/apartments`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();

                if (!result.success) throw new Error(result.message);

                const buildingState = result.data || [];
                console.log("Loaded building data:", buildingState.length, "rooms");
                console.log("Searching for resident with phone:", userPhone);

                const myRoom = buildingState.find(item =>
                    item.residents && Array.isArray(item.residents) &&
                    item.residents.some(r => {
                        const rPhone = (r.phoneLogin || r.phone || "").toString().replace(/[\s\.\-\(\)]/g, '');
                        if (rPhone === userPhone) {
                            console.log(`✅ Match found in room ${item.id} (Resident: ${r.name})`);
                            return true;
                        }
                        return false;
                    })
                );

                if (!myRoom) {
                    window.userHasRoom = false;
                    console.warn("❌ No room found for phone:", userPhone);
                } else {
                    window.userHasRoom = true;
                }

                // Refresh restricted sections and control button visibility
                const marketBtn = document.getElementById('btn-open-market-modal');
                const maintBtn = document.getElementById('btn-user-open-maintenance');
                const announcementSection = document.getElementById('user-announcement-section');
                const marketSection = document.getElementById('user-market-section');

                if (!window.userHasRoom) {
                    renderRestrictedPlaceholder('user-invoice-list', 'hóa đơn');
                    renderRestrictedPlaceholder('user-maintenance-list', 'yêu cầu');
                    if (marketBtn) marketBtn.style.display = 'none';
                    if (maintBtn) maintBtn.style.display = 'none';
                    if (announcementSection) announcementSection.style.display = 'none';
                    if (marketSection) marketSection.style.display = 'none';
                } else {
                    if (marketBtn) marketBtn.style.display = 'block';
                    if (maintBtn) maintBtn.style.display = 'block';
                    if (marketSection) marketSection.style.display = 'block';
                    // Announcement section visibility is controlled by loadUserAnnouncements
                }

                if (!myRoom) {
                    // Hide the standard section title since we're showing a special onboarding card
                    const dirTitle = document.getElementById('room-directory-title');
                    if (dirTitle) dirTitle.style.display = 'none';

                    container.innerHTML = `
                        <div class="onboarding-card">
                            <div class="onboarding-icon">
                                <i class="fa-solid fa-hand-sparkles"></i>
                            </div>
                            <div class="onboarding-content">
                                <h2>Chào mừng, ${(currentUser.name || 'Cư dân mới')}!</h2>
                                <p>
                                    Tài khoản <b>${currentUser.phone}</b> của bạn đã sẵn sàng. 
                                    <br><br>
                                    <span style="color: #fbbf24; font-weight: bold;">LƯU Ý:</span> Để xem được đầy đủ thông tin phòng, hóa đơn và chợ cư dân, bạn cần liên hệ Ban quản lý để được gán vào đúng số căn hộ của mình.
                                </p>
                                <div class="onboarding-features">
                                    <div class="feature-tag"><i class="fa-solid fa-bullhorn"></i> Tin tức</div>
                                    <div class="feature-tag"><i class="fa-solid fa-store"></i> Chợ cư dân</div>
                                    <div class="feature-tag"><i class="fa-solid fa-camera"></i> Đăng tin</div>
                                    <div class="feature-tag"><i class="fa-solid fa-wrench"></i> Bảo trì</div>
                                </div>
                                <p style="font-size: 0.8rem; margin-top: 1.5rem; color: #64748b; margin-bottom: 0;">
                                    <i class="fa-solid fa-info-circle"></i> Đã được gán phòng mà vẫn thấy thông báo này? Vui lòng kiểm tra lại SĐT đã báo với Admin.
                                </p>
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';
                const mainTitle = document.getElementById('room-directory-title');
                if (mainTitle) {
                    mainTitle.style.display = 'block';
                    mainTitle.textContent = 'Thông Tin Phòng Của Bạn';
                }

                // Generate Residents List HTML
                const residentsHtml = myRoom.residents.map(resident => `
                        <li class="member-item">
                            <div class="member-avatar">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div class="member-info">
                                <span class="member-name">
                                    ${resident.name}
                                    ${(resident.phoneLogin && resident.phoneLogin.trim() === userPhone) ? '<span style="color:var(--accent-green); font-size:0.8em; margin-left:5px">(Bạn)</span>' : ''}
                                </span>
                                <span class="member-role">
                                    ${resident.gender} · ${resident.dob ? new Date(resident.dob).getFullYear() : 'N/A'}
                                    ${resident.plate ? `<br><small><i class="fa-solid fa-motorcycle"></i> ${resident.plate}</small>` : ''}
                                </span>
                            </div>
                        </li>
                        `).join('');

                const card = document.createElement('div');
                card.className = 'room-entry';
                card.innerHTML = `
                        <div class="room-header">
                            <span class="room-name"><i class="fa-solid fa-door-open"></i> Phòng ${myRoom.id}</span>
                            <span class="member-count">${myRoom.residents.length} thành viên</span>
                        </div>
                        <ul class="member-list">
                            ${residentsHtml}
                        </ul>
                        `;

                container.appendChild(card);

            } catch (error) {
                console.error("Error loading directory:", error);
                container.innerHTML = '<div class="empty-state"><p>Lỗi khi tải dữ liệu từ server. Vui lòng thử lại sau.</p></div>';
            }
        }

        // Helper to render restricted placeholder
        function renderRestrictedPlaceholder(elementId, typeName) {
            const list = document.getElementById(elementId);
            if (!list) return;
            const colSpan = elementId.includes('invoice') ? 4 : 5;
            const icon = elementId.includes('invoice') ? 'fa-file-invoice-dollar' : 'fa-wrench';

            list.innerHTML = `<tr><td colspan="${colSpan}" style="text-align:center; padding:3rem; color: var(--text-secondary);">
                <div style="opacity: 0.6;">
                    <i class="fa-solid ${icon} fa-3x" style="margin-bottom: 1.5rem; display: block; color: var(--accent-blue);"></i>
                    <h3 style="color: white; margin-bottom: 0.5rem;">Tính năng này chưa sẵn sàng</h3>
                    <p>Bạn sẽ xem được ${typeName} sau khi Ban quản lý gán bạn vào căn hộ.</p>
                </div>
            </td></tr>`;
        }

        async function loadInvoices() {
            if (!window.userHasRoom) {
                renderRestrictedPlaceholder('user-invoice-list', 'hóa đơn');
                return;
            }
            try {
                const token = localStorage.getItem('authToken');
                const res = await fetch(`${API_URL}/invoices`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();

                const list = document.getElementById('user-invoice-list');
                list.innerHTML = '';

                if (result.success && result.data.length > 0) {
                    result.data.forEach(inv => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>Tháng ${inv.month}/${inv.year}</td>
                            <td><strong>${inv.totalAmount.toLocaleString()} đ</strong></td>
                            <td>
                                <span class="status-badge ${inv.status}">${inv.status === 'paid' ? 'Đã thanh toán' : 'Chưa thanh toán'}</span>
                                ${inv.status === 'pending' && inv.paymentRequest ? '<br><small style="color: #fbbf24; font-size: 0.75rem;"><i class="fa-solid fa-clock"></i> Đang chờ xác nhận</small>' : ''}
                            </td>
                            <td>
                                <button class="btn-check" onclick="viewInvoiceDetail('${inv._id}')">
                                    <i class="fa-solid fa-eye"></i> Xem & Thanh toán
                                </button>
                            </td>
                        `;
                        list.appendChild(tr);
                    });
                } else {
                    const msg = result.message || "Bạn chưa có hóa đơn nào.";
                    list.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:2rem; color: var(--text-secondary);">
                        <i class="fa-solid fa-receipt fa-2x" style="display:block; margin-bottom: 1rem; opacity: 0.5;"></i>
                        ${msg === 'Chưa có thông tin phòng' ? 'Tính năng này sẽ khả dụng sau khi bạn được gán phòng.' : msg}
                    </td></tr>`;
                }
            } catch (err) {
                console.error("Lỗi hđ:", err);
                const list = document.getElementById('user-invoice-list');
                list.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:2rem;">Lỗi khi tải hóa đơn. Vui lòng thử lại.</td></tr>';
            }
        }

        let currentInvoices = []; // To store loaded data for detail view

        window.viewInvoiceDetail = async (id) => {
            const token = localStorage.getItem('authToken');
            const res = await fetch(`${API_URL}/invoices`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            const inv = data.data.find(i => i._id === id);
            if (!inv) return;

            const content = document.getElementById('invoice-receipt-content');

            // VietQR logic (example: MB Bank)
            const BANK_ID = "MB";
            const ACCOUNT_NO = "0969696969"; // Tài khoản nhận tiền (SĐT Admin/Chủ nhà)
            const ACCOUNT_NAME = "NGUYEN VAN ADMIN";
            const AMOUNT = inv.totalAmount;
            const DESCRIPTION = `P.${inv.roomName} thanh toan thang ${inv.month}`;
            const qrUrl = `https://img.vietqr.io/image/${BANK_ID}-${ACCOUNT_NO}-compact2.png?amount=${AMOUNT}&addInfo=${encodeURIComponent(DESCRIPTION)}&accountName=${encodeURIComponent(ACCOUNT_NAME)}`;

            content.innerHTML = `
                        <div class="receipt">
                            <div class="receipt-header">
                                <h3 style="color: var(--accent-blue); margin-bottom: 0.5rem;">PHIẾU THU TIỀN PHÒNG</h3>
                                <p style="font-weight: bold; font-size: 1.1rem;">Phòng ${inv.roomName} - Tháng ${inv.month}/${inv.year}</p>
                            </div>
                            <div class="receipt-body">
                                <div class="receipt-row" style="border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 0.5rem; margin-bottom: 0.5rem;">
                                    <span>Người đại diện:</span> <span>${inv.representativeName || '-'}</span>
                                </div>
                                <div class="receipt-row">
                                    <span>Số người ở:</span> <span>${inv.residentCount || 0} người</span>
                                </div>
                                <div class="receipt-row">
                                    <span>Giá thuê phòng:</span> <span>${(inv.roomPrice || 0).toLocaleString()} đ</span>
                                </div>
                                <div class="receipt-row">
                                    <span>Tiền Internet (100k/ng):</span> <span>${(inv.internetFee || 0).toLocaleString()} đ</span>
                                </div>
                                <div class="receipt-row">
                                    <span>Tiền Nước (100k/ng):</span> <span>${(inv.waterFee || 0).toLocaleString()} đ</span>
                                </div>
                                <div class="receipt-row">
                                    <span>Dịch vụ chung (200k/ng):</span> <span>${(inv.serviceFee || 0).toLocaleString()} đ</span>
                                </div>

                                <div style="margin: 1rem 0; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem;">
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.3rem;">Chi tiết tiền điện:</div>
                                    <div class="receipt-row">
                                        <span>Chỉ số: ${inv.electricity.oldValue} ➞ ${inv.electricity.newValue}</span>
                                        <span>${(inv.electricity.newValue - inv.electricity.oldValue)} kWh</span>
                                    </div>
                                    <div class="receipt-row" style="font-weight: bold; margin-top: 0.2rem;">
                                        <span>Tiền điện (x 2.500đ):</span>
                                        <span>${((inv.electricity.newValue - inv.electricity.oldValue) * inv.electricity.price).toLocaleString()} đ</span>
                                    </div>
                                </div>

                                <div class="receipt-total" style="margin-top: 1.5rem; border-top: 2px solid var(--accent-blue); padding-top: 1rem;">
                                    <span>TỔNG CỘNG</span>
                                    <span style="color: #fbbf24; font-size: 1.4rem;">${inv.totalAmount.toLocaleString()} đ</span>
                                </div>
                            </div>
                            ${inv.status === 'pending' ? `
                        <div class="payment-qr" style="margin-top: 2rem; padding: 1rem; background: white; border-radius: 1rem; color: #333;">
                            <p style="font-weight: bold; margin-bottom: 0.5rem;">Quét mã QR thanh toán:</p>
                            <img src="${qrUrl}" alt="QR Thanh toán" style="width: 100%; max-width: 250px; margin: 0 auto; display: block;">
                            <p style="font-size: 0.8rem; margin-top: 0.5rem; color: #666;">Chuyển khoản đến MB Bank: ${ACCOUNT_NO}</p>
                            <small style="color: #888;">Nội dung: ${DESCRIPTION}</small>
                            ${inv.paymentRequest ? `
                                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border-radius: 0.5rem; color: #10b981; font-weight: 500;">
                                    <i class="fa-solid fa-check-circle"></i> Đã gửi báo cáo thanh toán cho Admin
                                </div>
                            ` : `
                                <button class="btn-primary" id="btn-request-pay-${inv._id}" onclick="requestPaymentConfirm('${inv._id}')" 
                                        style="width: 100%; margin-top: 1rem; background: #10b981; border: none;">
                                    <i class="fa-solid fa-paper-plane"></i> Tôi đã chuyển khoản
                                </button>
                            `}
                        </div>
                    ` : '<div class="paid-stamp" style="border: 4px double #10b981; color: #10b981; padding: 0.5rem 1.5rem; transform: rotate(-15deg); font-weight: 900; font-size: 1.5rem; width: fit-content; margin: 2rem auto;">ĐÃ THANH TOÁN</div>'}
                        </div>
                        `;

            document.getElementById('invoice-detail-modal').classList.remove('hidden');
        };

        window.requestPaymentConfirm = async (id) => {
            try {
                const token = localStorage.getItem('authToken');
                const res = await fetch(`${API_URL}/invoices/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ paymentRequest: true })
                });

                if (res.ok) {
                    alert("📩 Đã gửi thông báo cho Admin. Vui lòng chờ Admin kiểm tra và xác nhận hóa đơn của bạn.");
                    document.getElementById('invoice-detail-modal').classList.add('hidden');
                    loadInvoices(); // Reload list to reflect status if needed
                } else {
                    alert("Lỗi khi gửi thông báo.");
                }
            } catch (e) {
                console.error(e);
                alert("Lỗi kết nối.");
            }
        };

        // Close modal handlers
        document.getElementById('close-invoice-detail').onclick = () => {
            document.getElementById('invoice-detail-modal').classList.add('hidden');
        };

        window.onclick = (e) => {
            const modal = document.getElementById('invoice-detail-modal');
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        };

        // --- Maintenance Logic ---
        let currentMaintData = [];

        async function loadMaintenance() {
            if (!window.userHasRoom) {
                renderRestrictedPlaceholder('user-maintenance-list', 'yêu cầu');
                return;
            }
            try {
                const token = localStorage.getItem('authToken');
                const res = await fetch(`${API_URL}/maintenance`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();
                const list = document.getElementById('user-maintenance-list');
                list.innerHTML = '';

                if (result.success && result.data.length > 0) {
                    currentMaintData = result.data;
                    result.data.forEach(req => {
                        const date = new Date(req.createdAt).toLocaleDateString('vi-VN');
                        const typeLabel = req.type === 'maintenance' ? 'Bảo trì' : 'Góp ý';
                        let statusText = '';
                        switch (req.status) {
                            case 'pending': statusText = 'Chờ xử lý'; break;
                            case 'in-progress': statusText = 'Đang xử lý'; break;
                            case 'completed': statusText = 'Hoàn thành'; break;
                            case 'cancelled': statusText = 'Đã hủy'; break;
                        }

                        const tr = document.createElement('tr');
                        tr.className = 'maint-row-clickable';
                        tr.onclick = () => viewMaintDetail(req._id);

                        tr.innerHTML = `
                            <td style="padding: 1rem;">${date}</td>
                            <td style="padding: 1rem; max-width: 250px;">
                                <div class="text-truncate" style="font-weight: 700;">${req.title}</div>
                                <div class="text-truncate" style="font-size: 0.8rem; color: #94a3b8;">${req.description}</div>
                            </td>
                            <td style="padding: 1rem;">${typeLabel}</td>
                            <td style="padding: 1rem;"><span class="status-badge ${req.status}">${statusText}</span></td>
                            <td style="padding: 1rem;">
                                ${req.status === 'pending' ? `<button class="btn-check" style="border-color: #ef4444; color: #ef4444; background: rgba(239, 68, 68, 0.1);" onclick="event.stopPropagation(); cancelMaintenance('${req._id}')">Hủy</button>` : '-'}
                            </td>
                        `;
                        list.appendChild(tr);
                    });
                } else {
                    const msg = result.message || "Bạn chưa có yêu cầu nào.";
                    list.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:2rem; color: var(--text-secondary);">
                        <i class="fa-solid fa-wrench fa-2x" style="display:block; margin-bottom: 1rem; opacity: 0.5;"></i>
                        ${msg === 'Chưa có thông tin phòng' ? 'Tính năng này sẽ khả dụng sau khi bạn được gán phòng.' : msg}
                    </td></tr>`;
                }
            } catch (err) {
                console.error(err);
            }
        }

        function viewMaintDetail(id) {
            const req = currentMaintData.find(r => r._id === id);
            if (!req) return;

            let statusText = '';
            switch (req.status) {
                case 'pending': statusText = 'Chờ xử lý'; break;
                case 'in-progress': statusText = 'Đang xử lý'; break;
                case 'completed': statusText = 'Hoàn thành'; break;
                case 'cancelled': statusText = 'Đã hủy'; break;
            }

            const typeLabel = req.type === 'maintenance' ? 'Bảo trì / Sửa chữa' : 'Ý kiến đóng góp';
            const date = new Date(req.createdAt).toLocaleString('vi-VN');

            const body = document.getElementById('maint-detail-body');
            body.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Loại yêu cầu</span>
                    <div class="detail-value">${typeLabel}</div>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Thời gian gửi</span>
                    <div class="detail-value">${date}</div>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Mức độ ưu tiên</span>
                    <div class="detail-value">
                        <span class="priority-badge priority-${req.priority}">
                            ${req.priority === 'high' ? 'KHẨN CẤP' : (req.priority === 'medium' ? 'THƯỜNG' : 'THẤP')}
                        </span>
                    </div>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Trạng thái</span>
                    <div class="detail-value"><span class="status-badge ${req.status}">${statusText}</span></div>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Tiêu đề</span>
                    <div class="detail-value"><strong>${req.title}</strong></div>
                </div>
                <div class="detail-row" style="border-bottom: none;">
                    <span class="detail-label">Nội dung chi tiết</span>
                    <div class="detail-value" style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 0.5rem; margin-top: 0.5rem; white-space: pre-wrap;">${req.description}</div>
                </div>
                ${req.mediaUrl ? `
                    <div class="detail-row" style="border-bottom: none; margin-top: 1rem;">
                        <span class="detail-label"><i class="fa-solid fa-image"></i> Ảnh/Video đính kèm</span>
                        <div class="detail-value" style="margin-top: 0.5rem; text-align: center;">
                            ${req.mediaType === 'image'
                        ? `<img src="${req.mediaUrl}" style="max-width: 100%; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3);" alt="Ảnh sự cố">`
                        : `<video src="${req.mediaUrl}" controls style="max-width: 100%; border-radius: 0.5rem;"></video>`
                    }
                        </div>
                    </div>
                ` : ''}
            `;

            document.getElementById('maint-detail-modal').classList.remove('hidden');
        }

        const closeMaintDetailBtn = document.getElementById('close-maint-detail');
        if (closeMaintDetailBtn) {
            closeMaintDetailBtn.onclick = () => document.getElementById('maint-detail-modal').classList.add('hidden');
        }

        window.addEventListener('click', (e) => {
            const modal = document.getElementById('maint-detail-modal');
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });

        let currentAnnData = [];

        async function loadUserAnnouncements() {
            if (!window.userHasRoom) {
                const section = document.getElementById('user-announcement-section');
                if (section) section.style.display = 'none';
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const res = await fetch(`${API_URL}/announcements`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();

                const section = document.getElementById('user-announcement-section');
                const list = document.getElementById('user-announcement-list');

                if (result.success && result.data.length > 0) {
                    currentAnnData = result.data;
                    section.style.display = 'block';
                    list.innerHTML = '';

                    result.data.forEach(ann => {
                        const date = new Date(ann.createdAt).toLocaleDateString('vi-VN');
                        let icon = 'fa-bullhorn';
                        let colorStyle = '#3b82f6';
                        if (ann.type === 'urgent') { icon = 'fa-triangle-exclamation'; colorStyle = '#ef4444'; }
                        if (ann.type === 'event') { icon = 'fa-calendar-check'; colorStyle = '#10b981'; }

                        const card = document.createElement('div');
                        card.className = 'glass-panel announcement-card-clickable';
                        card.style.marginBottom = '0';
                        card.style.padding = '1.25rem';
                        card.style.borderLeft = `4px solid ${colorStyle}`;
                        card.style.display = 'flex';
                        card.style.flexDirection = 'column';
                        card.style.justifyContent = 'space-between';
                        card.onclick = () => viewAnnouncementDetail(ann);

                        card.innerHTML = `
                        <div style="min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <i class="fa-solid ${icon}" style="color: ${colorStyle}; font-size: 1rem;"></i>
                                <h3 class="text-truncate" style="margin: 0; font-size: 1rem; color: #fff; flex: 1;">${ann.title}</h3>
                            </div>
                            <div class="text-truncate" style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 0.5rem;">${ann.content}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255,255,255,0.05); pt: 0.5rem; margin-top: auto;">
                            <span style="font-size: 0.7rem; color: #64748b;"><i class="fa-solid fa-user-edit" style="font-size: 0.65rem;"></i> ${ann.createdBy || 'BQL'} • ${date}</span>
                            <span style="font-size: 0.75rem; color: ${colorStyle}; font-weight: 600;">Xem chi tiết <i class="fa-solid fa-chevron-right" style="font-size: 0.6rem;"></i></span>
                        </div>
                        `;
                        list.appendChild(card);
                    });
                }
            } catch (err) {
                console.error("Lỗi tải thông báo", err);
            }
        }

        function viewAnnouncementDetail(ann) {
            const modal = document.getElementById('ann-detail-modal');
            const body = document.getElementById('ann-detail-body');
            if (!modal || !body) return;

            const date = new Date(ann.createdAt).toLocaleString('vi-VN');
            let colorStyle = '#3b82f6';
            let typeName = 'Thông báo chung';
            if (ann.type === 'urgent') { colorStyle = '#ef4444'; typeName = 'Khẩn cấp'; }
            if (ann.type === 'event') { colorStyle = '#10b981'; typeName = 'Sự kiện'; }

            let mediaHtml = '';
            if (ann.mediaType === 'image' && ann.mediaUrl) {
                mediaHtml = `<img src="${ann.mediaUrl}" style="max-width: 100%; border-radius: 0.75rem; margin-top: 1.5rem; display: block; box-shadow: 0 4px 12px rgba(0,0,0,0.3);" alt="Media">`;
            } else if (ann.mediaType === 'video' && ann.mediaUrl) {
                mediaHtml = `<video src="${ann.mediaUrl}" controls style="max-width: 100%; border-radius: 0.75rem; margin-top: 1.5rem; display: block;"></video>`;
            }

            body.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; align-items: center;">
                        <span style="background: ${colorStyle}20; color: ${colorStyle}; padding: 0.25rem 0.75rem; border-radius: 2rem; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">
                            ${typeName}
                        </span>
                        <span style="color: var(--text-secondary); font-size: 0.85rem;"><i class="fa-regular fa-clock"></i> ${date}</span>
                        <span style="color: var(--text-secondary); font-size: 0.85rem;">• <i class="fa-solid fa-user-pen"></i> Người đăng: <strong>${ann.createdBy || 'Ban Quản Lý'}</strong></span>
                    </div>
                    <h3 style="color: white; font-size: 1.4rem; line-height: 1.3; margin-bottom: 1rem;">${ann.title}</h3>
                    <div style="color: #cbd5e1; line-height: 1.6; font-size: 1.05rem; white-space: pre-wrap; background: rgba(0,0,0,0.2); padding: 1.25rem; border-radius: 0.75rem;">${ann.content}</div>
                    ${mediaHtml}
                </div>
            `;

            modal.classList.remove('hidden');
        }

        const closeAnnDetailBtn = document.getElementById('close-ann-detail');
        if (closeAnnDetailBtn) {
            closeAnnDetailBtn.onclick = () => document.getElementById('ann-detail-modal').classList.add('hidden');
        }
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('ann-detail-modal');
            if (e.target === modal) modal.classList.add('hidden');
        });

        window.openMaintenanceModal = () => {
            if (!window.userHasRoom) {
                alert("Bạn cần được gán vào phòng để thực hiện chức năng này.");
                return;
            }
            document.getElementById('maintenance-modal').classList.remove('hidden');
        };

        document.getElementById('close-maintenance').onclick = () => {
            document.getElementById('maintenance-modal').classList.add('hidden');
        };

        // Media preview for maintenance
        document.getElementById('maint-media').addEventListener('change', function (e) {
            const file = e.target.files[0];
            const preview = document.getElementById('maint-media-preview');

            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    preview.style.display = 'block';
                    preview.innerHTML = `<img src="${event.target.result}" style="max-width: 100%; max-height: 200px; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">`;
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
                preview.innerHTML = '';
            }
        });

        document.getElementById('maintenance-form').onsubmit = async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('authToken');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;

            // Disable button during upload
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang gửi...';

            try {
                // Get resident's room info first to fill the request
                const apartmentsRes = await fetch(`${API_URL}/apartments`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const apartmentsData = await apartmentsRes.json();
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const myRoom = apartmentsData.data.find(room =>
                    room.residents && room.residents.some(r => r.phoneLogin === currentUser.phone)
                );

                if (!myRoom) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    return alert("Không tìm thấy thông tin phòng của bạn!");
                }

                let mediaUrl = '';
                let mediaType = '';

                // Upload media if exists
                const mediaFile = document.getElementById('maint-media').files[0];
                if (mediaFile) {
                    // Check file size (max 2MB for images)
                    const maxSize = 2 * 1024 * 1024; // 2MB
                    if (mediaFile.size > maxSize) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        return alert('Ảnh quá lớn! Tối đa 2MB\n\nGợi ý: Nén ảnh trước khi gửi');
                    }

                    submitBtn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up fa-beat"></i> Đang tải ảnh...';

                    try {
                        // Convert to base64
                        const reader = new FileReader();
                        const base64Promise = new Promise((resolve, reject) => {
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(mediaFile);
                        });

                        mediaUrl = await base64Promise;
                        mediaType = 'image';
                    } catch (uploadError) {
                        console.error('Upload error:', uploadError);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        return alert('Lỗi khi tải ảnh: ' + uploadError.message);
                    }
                }

                submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane fa-beat"></i> Đang gửi yêu cầu...';

                const body = {
                    roomId: myRoom.id,
                    roomName: `Phòng ${myRoom.id}`,
                    senderName: currentUser.name,
                    type: document.getElementById('maint-type').value,
                    priority: document.getElementById('maint-priority').value,
                    title: document.getElementById('maint-title').value.trim(),
                    description: document.getElementById('maint-description').value.trim(),
                    mediaUrl: mediaUrl,
                    mediaType: mediaType
                };

                const res = await fetch(`${API_URL}/maintenance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });
                const result = await res.json();
                if (result.success) {
                    alert("✅ Yêu cầu của bạn đã được gửi!");
                    document.getElementById('maintenance-modal').classList.add('hidden');
                    document.getElementById('maintenance-form').reset();
                    document.getElementById('maint-media-preview').style.display = 'none';
                    document.getElementById('maint-media-preview').innerHTML = '';
                    loadMaintenance();
                } else {
                    alert(result.message || "Lỗi gửi yêu cầu");
                }
            } catch (err) {
                console.error(err);
                alert("Lỗi gửi yêu cầu: " + err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        };

        window.cancelMaintenance = async (id) => {
            if (!confirm("Bạn có chắc muốn hủy yêu cầu này?")) return;
            try {
                const token = localStorage.getItem('authToken');
                await fetch(`${API_URL}/maintenance/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: 'cancelled' })
                });
                loadMaintenance();
            } catch (err) {
                alert("Lỗi hủy yêu cầu");
            }
        };

        // ==================== MARKETPLACE LOGIC ====================
        let currentMarketMedia = '';
        let allMarketItems = [];

        async function loadMarketItems() {
            const list = document.getElementById('user-market-list');
            if (!list) return;

            if (!window.userHasRoom) {
                list.innerHTML = '<div style="text-align: center; color: #64748b; width: 100%; padding: 2rem;">Bạn cần được gán vào phòng để xem Chợ cư dân.</div>';
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const res = await fetch(`${API_URL}/market`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();

                if (result.success) {
                    allMarketItems = result.data;
                    const tokenPayload = JSON.parse(atob(token.split('.')[1]));
                    const myId = tokenPayload.id;

                    if (allMarketItems.length === 0) {
                        list.innerHTML = '<div style="text-align: center; color: #aaa; width: 100%; padding: 2rem;">Chưa có tin rao vặt nào.</div>';
                        return;
                    }

                    list.innerHTML = allMarketItems.map(item => {
                        const isOwner = item.createdBy === myId;
                        const deleteBtn = isOwner ? `
                            <button onclick="event.stopPropagation(); deleteMarketItem('${item._id}')" style="position: absolute; top: 10px; right: 10px; background: rgba(239, 68, 68, 0.9); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 10;">
                                <i class="fa-solid fa-trash" style="font-size: 0.8rem;"></i>
                            </button>
                        ` : '';

                        return `
                            <div class="glass-panel market-card market-card-small market-card-clickable" 
                                 style="position: relative;"
                                 onclick="viewMarketDetail('${item._id}')">
                                ${deleteBtn}
                                <img src="${item.image}" alt="Item">
                                <h4 class="text-truncate" style="margin: 0.5rem 0 0.2rem 0; color: white; font-size: 1rem;">${item.title}</h4>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem;">
                                    <span class="price-tag" style="font-size: 0.8rem;">${item.price.toLocaleString()} đ</span>
                                </div>
                                <div class="text-truncate" style="font-size: 0.8rem; color: #94a3b8;">
                                    <i class="fa-solid fa-phone" style="font-size: 0.7rem;"></i> ${item.contactPhone}
                                </div>
                                <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.3rem;">
                                    <i class="fa-solid fa-house-user" style="font-size: 0.7rem;"></i> ${item.roomName || 'N/A'}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error("Lỗi tải chợ:", err);
            }
        }

        function viewMarketDetail(id) {
            const item = allMarketItems.find(i => i._id === id);
            if (!item) return;

            const modal = document.getElementById('mkt-detail-modal');
            const body = document.getElementById('mkt-detail-body');
            if (!modal || !body) return;

            body.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <img src="${item.image}" style="width: 100%; max-height: 350px; object-fit: cover; border-radius: 0.75rem; margin-bottom: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.4);" alt="Product">
                    
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
                        <h3 style="color: white; font-size: 1.5rem; margin: 0; line-height: 1.2;">${item.title}</h3>
                        <span class="price-tag" style="font-size: 1.2rem; padding: 0.4rem 1rem;">${item.price.toLocaleString()} đ</span>
                    </div>

                    <div style="display: flex; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 0.5rem;">
                        <div>
                            <span style="display: block; font-size: 0.75rem; color: #94a3b8; text-transform: uppercase;">Liên hệ</span>
                            <strong style="color: #10b981; font-size: 1.1rem;"><i class="fa-solid fa-phone"></i> ${item.contactPhone}</strong>
                        </div>
                        <div>
                            <span style="display: block; font-size: 0.75rem; color: #94a3b8; text-transform: uppercase;">Phòng</span>
                            <strong style="color: #3b82f6; font-size: 1.1rem;"><i class="fa-solid fa-house-circle-check"></i> ${item.roomName || 'N/A'}</strong>
                        </div>
                        <div>
                            <span style="display: block; font-size: 0.75rem; color: #94a3b8; text-transform: uppercase;">Ngày đăng</span>
                            <strong style="color: white;">${new Date(item.createdAt).toLocaleDateString('vi-VN')}</strong>
                        </div>
                    </div>

                    <div style="color: #cbd5e1; line-height: 1.6; font-size: 1rem;">
                        <span style="display: block; font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">Mô tả sản phẩm</span>
                        <div style="white-space: pre-wrap; background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 0.5rem;">${item.description || 'Không có mô tả chi tiết cho sản phẩm này.'}</div>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
        }

        const closeMktDetailBtn = document.getElementById('close-mkt-detail');
        if (closeMktDetailBtn) {
            closeMktDetailBtn.onclick = () => document.getElementById('mkt-detail-modal').classList.add('hidden');
        }

        window.addEventListener('click', (e) => {
            const modal = document.getElementById('mkt-detail-modal');
            if (e.target === modal) modal.classList.add('hidden');
        });


        window.openMarketModal = () => {
            if (!window.userHasRoom) {
                alert("Bạn cần được gán vào phòng để thực hiện chức năng này.");
                return;
            }
            document.getElementById('market-modal').classList.remove('hidden');
        };

        const closeMarketModalBtn = document.getElementById('close-market-modal');
        if (closeMarketModalBtn) {
            closeMarketModalBtn.onclick = () => {
                document.getElementById('market-modal').classList.add('hidden');
                document.getElementById('market-form').reset();
                document.getElementById('mkt-preview').style.display = 'none';
                currentMarketMedia = '';
            };
        }

        const mktFileInput = document.getElementById('mkt-file');
        if (mktFileInput) {
            mktFileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 5 * 1024 * 1024) {
                    alert("Ảnh quá lớn (Max 5MB)");
                    e.target.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = (ev) => {
                    currentMarketMedia = ev.target.result;
                    const preview = document.getElementById('mkt-preview');
                    preview.style.display = 'block';
                    preview.innerHTML = `<img src="${currentMarketMedia}" style="max-height: 150px; border-radius: 4px;">`;
                };
                reader.readAsDataURL(file);
            };
        }

        const marketForm = document.getElementById('market-form');
        if (marketForm) {
            marketForm.onsubmit = async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang đăng...';
                btn.disabled = true;

                if (!currentMarketMedia) {
                    alert("Vui lòng chọn ảnh món đồ");
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }

                try {
                    const token = localStorage.getItem('authToken');

                    // Find user's room info
                    const apartmentsRes = await fetch(`${API_URL}/apartments`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const apartmentsData = await apartmentsRes.json();
                    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                    const myRoom = (apartmentsData.data || []).find(room =>
                        room.residents && room.residents.some(r => r.phoneLogin === currentUser.phone)
                    );

                    const data = {
                        title: document.getElementById('mkt-title').value,
                        price: parseFloat(document.getElementById('mkt-price').value),
                        contactPhone: document.getElementById('mkt-phone').value,
                        description: document.getElementById('mkt-desc').value,
                        roomName: myRoom ? `Phòng ${myRoom.id}` : (currentUser.role === 'admin' ? 'BQL' : 'N/A'),
                        image: currentMarketMedia
                    };

                    const res = await fetch(`${API_URL}/market`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });
                    const result = await res.json();
                    if (result.success) {
                        alert("✅ Đã đăng tin thành công!");
                        document.getElementById('market-modal').classList.add('hidden');
                        marketForm.reset();
                        document.getElementById('mkt-preview').style.display = 'none';
                        currentMarketMedia = '';
                        loadMarketItems();
                    } else {
                        alert("Lỗi: " + result.message);
                    }
                } catch (err) {
                    console.error(err);
                    alert("Lỗi kết nối");
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            };
        }

        window.deleteMarketItem = async (id) => {
            if (!confirm("Bạn có chắc muốn xóa tin này?")) return;
            try {
                const token = localStorage.getItem('authToken');
                const res = await fetch(`${API_URL}/market/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();
                if (result.success) {
                    loadMarketItems();
                } else {
                    alert(result.message || "Không thể xóa");
                }
            } catch (err) {
                alert("Lỗi kết nối");
            }
        };

        // Close modal on outside click
        window.addEventListener('click', (e) => {
            const mktModal = document.getElementById('market-modal');
            if (mktModal && e.target === mktModal) {
                mktModal.classList.add('hidden');
            }
        });

        // ==================== CONTRACT LOGIC ====================

        async function loadUserContract() {
            const container = document.getElementById('user-contract-section');
            if (!container) return;

            // Show loading state
            container.innerHTML = '<div style="text-align:center; padding: 2rem; color: #ccc;"><i class="fa-solid fa-spinner fa-spin"></i> Đang tải hợp đồng...</div>';

            try {
                const token = localStorage.getItem('authToken');
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

                // 1. Get current room info to know myRoomId
                const aptRes = await fetch(`${API_URL}/apartments`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const aptData = await aptRes.json();
                const myRoom = (aptData.data || []).find(room =>
                    room.residents && room.residents.some(r => r.phoneLogin === currentUser.phone)
                );
                const myRoomId = myRoom ? myRoom.id : null;

                if (!myRoomId && currentUser.role !== 'admin') {
                    container.innerHTML = '<div class="glass-panel" style="padding: 1.5rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">Bạn sẽ xem được hợp đồng sau khi được gán vào phòng.</div>';
                    return;
                }

                // 2. Fetch contracts
                const res = await fetch(`${API_URL}/contracts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();

                // 3. Filter Logic
                // - Show if it's MY contract (history)
                // - OR if it's the ACTIVE contract of my CURRENT room (for roommates)
                const myPhoneNormal = (currentUser.phone || '').replace(/\D/g, '');

                const filteredContracts = (result.data || []).filter(c => {
                    const cPhone = (c.tenantPhone || '').replace(/\D/g, '');
                    const isMyContract = (cPhone === myPhoneNormal);
                    const isCurrentRoomActive = (myRoomId && c.roomId === myRoomId && c.status === 'active');

                    return isMyContract || isCurrentRoomActive;
                });

                if (filteredContracts.length === 0) {
                    container.innerHTML = `
                         <div class="glass-panel" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                            <div style="opacity: 0.2; font-size: 3rem; margin-bottom: 0.5rem;"><i class="fa-solid fa-file-signature"></i></div>
                            <p style="font-size: 0.95rem; margin: 0;">Hiện chưa có hợp đồng nào.</p>
                        </div>
                    `;
                    return;
                }

                window.userContracts = filteredContracts;

                // Sort: Active first, then by date desc
                const sortedContracts = filteredContracts.sort((a, b) => {
                    if (a.status === 'active' && b.status !== 'active') return -1;
                    if (a.status !== 'active' && b.status === 'active') return 1;
                    return new Date(b.endDate) - new Date(a.endDate);
                });

                let html = `<div style="display: grid; gap: 1rem;">`;

                sortedContracts.forEach(contract => {
                    const now = new Date();
                    const endDate = new Date(contract.endDate);
                    const startDate = new Date(contract.startDate);
                    const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));

                    let statusConfig = { color: '#94a3b8', bg: 'rgba(148, 163, 184, 0.1)', text: 'Đã kết thúc', icon: 'fa-check' };
                    let cardOpacity = '0.7';

                    if (contract.status === 'active') {
                        cardOpacity = '1';
                        if (daysLeft < 0) {
                            statusConfig = { color: '#ef4444', bg: 'rgba(239, 68, 68, 0.15)', text: 'Quá hạn', icon: 'fa-triangle-exclamation' };
                        } else if (daysLeft <= 30) {
                            statusConfig = { color: '#fbbf24', bg: 'rgba(251, 191, 36, 0.15)', text: `Hết hạn trong ${daysLeft} ngày`, icon: 'fa-clock' };
                        } else {
                            statusConfig = { color: '#10b981', bg: 'rgba(16, 185, 129, 0.15)', text: 'Đang hiệu lực', icon: 'fa-circle-check' };
                        }
                    }

                    html += `
                        <div onclick="viewUserContractDetail('${contract._id}')" 
                             class="glass-panel contract-hover-effect"
                             style="
                                padding: 0; 
                                overflow: hidden; 
                                cursor: pointer; 
                                transition: all 0.2s ease;
                                opacity: ${cardOpacity};
                                position: relative;
                                border: 1px solid rgba(255,255,255,0.05);
                             ">
                            <!-- Header Bar -->
                            <div style="padding: 1rem 1.25rem; background: rgba(255,255,255,0.02); border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div style="background: var(--accent-blue); width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                                        <i class="fa-solid fa-file-contract"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 1rem; color: #fff;">Phòng ${contract.roomName}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">Số HĐ: #${contract._id.substr(-6).toUpperCase()}</div>
                                    </div>
                                </div>
                                <span style="
                                    background: ${statusConfig.bg}; 
                                    color: ${statusConfig.color}; 
                                    padding: 0.35rem 0.75rem; 
                                    border-radius: 2rem; 
                                    font-size: 0.75rem; 
                                    font-weight: 600; 
                                    display: flex; 
                                    align-items: center; 
                                    gap: 0.4rem;
                                    border: 1px solid ${statusConfig.color}20;
                                ">
                                    <i class="fa-solid ${statusConfig.icon}"></i> ${statusConfig.text}
                                </span>
                            </div>

                            <!-- Body Info -->
                            <div style="padding: 1.25rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.4rem;">Thời hạn thuê</div>
                                    <div style="font-size: 0.9rem; color: #e2e8f0; font-weight: 500;">
                                        ${startDate.toLocaleDateString('vi-VN')} <i class="fa-solid fa-arrow-right" style="font-size: 0.7rem; color: #64748b; margin: 0 0.3rem;"></i> ${endDate.toLocaleDateString('vi-VN')}
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.4rem;">Giá thuê</div>
                                    <div style="font-size: 1.1rem; color: var(--accent-green); font-weight: 700; display: flex; align-items: baseline; gap: 0.2rem;">
                                        ${contract.monthlyRent.toLocaleString()} <span style="font-size: 0.8rem; font-weight: 400; color: #94a3b8;">vnđ/tháng</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Hover Hint (Mobile Visible / Desktop Hover) -->
                            <div style="padding: 0.6rem 1.25rem; background: rgba(0,0,0,0.1); border-top: 1px solid rgba(255,255,255,0.03); text-align: right;">
                                <span style="font-size: 0.8rem; color: var(--accent-blue); font-weight: 500;">Xem chi tiết <i class="fa-solid fa-chevron-right" style="font-size: 0.7rem;"></i></span>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
                container.innerHTML = html;

            } catch (error) {
                console.error("User Contract Error:", error);
                container.innerHTML = '<div style="text-align:center; color: var(--text-secondary); font-size: 0.8rem;">Lỗi tải hợp đồng</div>';
            }
        }

        window.viewUserContractDetail = function (id) {
            const contract = window.userContracts.find(c => c._id === id);
            if (!contract) return;

            const modal = document.getElementById('user-contract-modal');
            const content = document.getElementById('user-contract-content');
            const now = new Date();
            const endDate = new Date(contract.endDate);

            content.innerHTML = `
                <div style="padding: 0.5rem;">
                    <div style="text-align: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <h2 style="color: var(--accent-blue); text-transform: uppercase; font-size: 1.25rem;">Hợp Đồng Thuê Nhà</h2>
                        <p style="color: var(--text-secondary);">Số: HD-${contract._id.substr(-6).toUpperCase()}</p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1.5rem;">
                        <div>
                            <h4 style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">BÊN CHO THUÊ (BÊN A)</h4>
                            <p style="font-weight: bold;">BAN QUẢN LÝ CHUNG CƯ HẠNH PHÚC</p>
                            <p>Đại diện: Admin</p>
                            <p>SĐT: 0969696969</p>
                        </div>
                        <div>
                            <h4 style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">BÊN THUÊ (BÊN B)</h4>
                            <p style="font-weight: bold;">${contract.tenantName}</p>
                            <p>SĐT: ${contract.tenantPhone}</p>
                            <p>CCCD: ${contract.tenantIdCard || '---'}</p>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                        <h4 style="color: var(--accent-green); margin-bottom: 0.5rem;"><i class="fa-solid fa-house"></i> Thông tin thuê</h4>
                        <ul style="list-style: none;">
                            <li style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Căn hộ số:</span> <strong>${contract.roomName}</strong>
                            </li>
                            <li style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Thời hạn thuê:</span> <strong>${contract.duration} tháng</strong>
                            </li>
                            <li style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Từ ngày:</span> <span>${new Date(contract.startDate).toLocaleDateString('vi-VN')}</span>
                            </li>
                            <li style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Đến ngày:</span> <span>${endDate.toLocaleDateString('vi-VN')}</span>
                            </li>
                             <li style="display: flex; justify-content: space-between; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 0.5rem; margin-top: 0.5rem;">
                                <span>Giá thuê:</span> <strong style="color: var(--accent-green);">${contract.monthlyRent.toLocaleString()} VNĐ/tháng</strong>
                            </li>
                        </ul>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color:var(--accent-amber); margin-bottom: 0.5rem;"><i class="fa-solid fa-sack-dollar"></i> Đặt cọc</h4>
                        <p>Bên B đã đặt cọc cho Bên A số tiền là: <strong>${contract.deposit.toLocaleString()} VNĐ</strong></p>
                        <p>Trạng thái: ${contract.depositPaid ? '<span style="color: #10b981; font-weight: bold;">ĐÃ THANH TOÁN</span>' : '<span style="color: #ef4444; font-weight: bold;">CHƯA THANH TOÁN</span>'}</p>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem;">* Số tiền này sẽ được hoàn trả khi kết thúc hợp đồng nếu không có vi phạm.</p>
                    </div>

                    ${contract.terms && contract.terms.length > 0 ? `
                        <div>
                            <h4 style="color: var(--text-secondary); margin-bottom: 0.5rem;"><i class="fa-solid fa-list-check"></i> Các điều khoản khác</h4>
                            <ul style="padding-left: 1.5rem; color: var(--text-primary);">
                                ${contract.terms.map(term => `<li style="margin-bottom: 0.25rem;">${term}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
            modal.classList.remove('hidden');
        };

        // Close modal
        const closeContractBtn = document.getElementById('close-user-contract');
        if (closeContractBtn) {
            closeContractBtn.onclick = () => {
                document.getElementById('user-contract-modal').classList.add('hidden');
            };
        }

        window.addEventListener('click', (e) => {
            const modal = document.getElementById('user-contract-modal');
            if (e.target === modal) modal.classList.add('hidden');
        });


    </script>
</body>

</html>